{"version":3,"sources":["../../../src/hashers/Blake3/index.ts","../../../src/hashers/SparkHasher/index.ts","../../../src/utilities/index.ts","../../../src/events/SparkEvent/index.ts","../../../src/errors/hashers.ts"],"sourcesContent":["import util from \"tweetnacl-util\";\nimport { HashData, HashDigest } from \"../SparkHasher/types\";\nimport { blake3 } from \"@noble/hashes/blake3\";\nimport { SparkHasher } from \"../SparkHasher\";\nimport { HasherErrors } from \"../../errors/hashers\";\nimport { SparkEvent } from \"../../events/SparkEvent\";\n\nexport class Blake3 extends SparkHasher {\n  public async import(data: Record<string, any>): Promise<void> {\n    await super.import(data);\n    return Promise.resolve();\n  }\n  \n  public async export(): Promise<Record<string, any>> {\n    const data = await super.export();\n    return Promise.resolve(data);\n  }\n\n  public async hash({ data }: { data: HashData }): ReturnType<SparkHasher['hash']> {\n    try {\n      const stringData = typeof data !== 'string' ? JSON.stringify(data) : data;\n      const hashedString = blake3(stringData);\n      const b64DHash = util.encodeBase64(hashedString);\n      if (!b64DHash) throw HasherErrors.HASING_ERROR();\n      return b64DHash as HashDigest;\n    } catch (error: any) {\n      if (error instanceof SparkEvent) return Promise.reject(error);\n      return Promise.reject(HasherErrors.HASHER_UNEXPECTED_ERROR({\n        message: `Failed to hash data. ${error?.message || ''}`,\n      }));\n    }\n  }\n}","import { HashDigest, SparkHasherInterface } from \"./types\";\n\nexport abstract class SparkHasher implements SparkHasherInterface {\n  constructor() {\n    this.hash = this.hash.bind(this);\n  }\n  \n  public async import(data: Record<string, any>): Promise<void> {\n    return Promise.resolve();\n  }\n  \n  public async export(): Promise<Record<string, any>> {\n    return Promise.resolve({});\n  }\n\n  public abstract hash(params?: Record<string, any>): Promise<HashDigest>;\n}","import nacl from \"tweetnacl\";\nimport util from \"tweetnacl-util\";\nimport { createId, isCuid } from '@paralleldrive/cuid2';\n\n/**\n * @returns a timestamp in milliseconds since epoch in terms of UTC\n */\nexport function utcEpochTimestamp() {\n  const now = new Date()\n  return now.getTime() + now.getTimezoneOffset() * 60 * 1000;\n}\n\n/**\n * @returns a parsed json string or null if it fails\n */\nexport function parseJSON(data: string) {\n  try {\n    return JSON.parse(data);\n  } catch (e) {\n    return data;\n  }\n}\n\n/**\n * @returns a new unique salt\n */\nexport function randomSalt(len: number = 32) {\n  return util.encodeBase64(nacl.randomBytes(len));\n}\n\n/**\n * @returns a new unique identifier\n */\nexport function randomCuid() {\n  return createId();\n}\n\n/**\n * @returns whether the identifier is a valid CUID\n */\nexport function validCuid(id: string) {\n  return isCuid(id);\n}\n\n/**\n * SNAKE_CASE to PascalCase\n * @returns a PascalCase string\n */\nexport function snakeToPascal(str: string) {\n  return str.toLowerCase().replace(/_([a-z])/g, (_, char) => char.toUpperCase()).replace(/^[a-z]/, char => char.toUpperCase());\n}","import { randomCuid, utcEpochTimestamp } from \"../../utilities\";\nimport { ConfirmEventType, CreateEventFunction, CreateEventParams, ErrorEventType, RequestEventType, SparkEventInterface, SparkEventParams } from \"./types\";\n\n\nexport class SparkEvent implements SparkEventInterface {\n  readonly type:  RequestEventType | ConfirmEventType | ErrorEventType;\n  readonly timestamp: number;\n  readonly metadata: Record<string, any>;\n  readonly data: Record<string, any>;\n  readonly digest: string;\n\n  constructor(args: SparkEventParams) {\n    this.type = args.type;\n    this.metadata = args.metadata;\n    this.timestamp = args.timestamp;\n    if (args.data) this.data = args.data;\n    if (args.digest) this.digest = args.digest;\n  }\n}\n\nexport class SparkRequestEvent extends SparkEvent {\n  declare readonly type: RequestEventType;\n}\nexport class SparkConfirmEvent extends SparkEvent {\n  declare readonly type: ConfirmEventType;\n}\nexport class SparkErrorEvent extends SparkEvent {\n  declare readonly type: ErrorEventType;\n}\n\nexport const createEvent: CreateEventFunction = (params: CreateEventParams): any => {\n  const { type, data, digest } = params;\n  const timestamp: number = utcEpochTimestamp();\n  const metadata = { ...(params.metadata || {}), eventId: randomCuid() };\n\n  const invalidEvent = (!type.endsWith(\"_REQUEST\") && !type.endsWith(\"_CONFIRM\") && !type.endsWith(\"_ERROR\"));\n  const invalidParams = !!((data && digest) || (!data && !digest));\n\n  let event;\n  if (!!data) event = new SparkEvent({ type, metadata, timestamp, data });\n  else if (!!digest) event = new SparkEvent({ type, metadata, timestamp, digest });\n  else event = null;\n\n  if (invalidEvent || invalidParams || !event) {\n    throw new SparkEvent({\n      type: 'CREATE_EVENT_ERROR',\n      metadata: {\n        eventId: randomCuid()\n      },\n      timestamp,\n      data: { message: invalidEvent ? `Invalid event type: ${type}` : `Invalid event params: ${JSON.stringify(params)}` },\n    });\n  }\n\n  // TODO - settings for optional logging\n  const isError = event.type.endsWith(\"_ERROR\");\n  // if (isError) console.error(event);\n\n  return event;\n};\n","import { createEvent } from \"../events/SparkEvent\";\n\nexport const HasherErrorTypes = {\n  HASING_ERROR: 'HASING_ERROR',\n  HASHER_UNEXPECTED_ERROR: 'HASHER_UNEXPECTED_ERROR',\n} as const;\n\nexport const HasherErrors = {\n  HASING_ERROR: ({ metadata = {} }: { metadata?: Record<string, any> } = {}) => createEvent({\n    type: HasherErrorTypes.HASING_ERROR,\n    metadata: { ...metadata },\n    data: { message: 'Failed to hash data.' }\n  }),\n  HASHER_UNEXPECTED_ERROR: ({ metadata = {}, message }: { metadata?: Record<string, any>, message?: string } = {}) => createEvent({\n    type: HasherErrorTypes.HASHER_UNEXPECTED_ERROR,\n    metadata: { ...metadata },\n    data: { message: message || 'Unexpected hasher error.' }\n  }),\n}\n\n"],"mappings":"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","names":["import_tweetnacl_util","util"]}